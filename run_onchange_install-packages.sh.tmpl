#!/bin/sh

if [ ! -f /etc/pacman.d/chaotic-mirrorlist ]; then
  # Import the chaotic-aur signing key
  sudo pacman-key --recv-key 3056513887B78AEB --keyserver keyserver.ubuntu.com
  sudo pacman-key --lsign-key 3056513887B78AEB

  # Install the chaotic-aur keyring and mirrorlist
  sudo pacman -U --noconfirm 'https://cdn-mirror.chaotic.cx/chaotic-aur/chaotic-keyring.pkg.tar.zst'
  sudo pacman -U --noconfirm 'https://cdn-mirror.chaotic.cx/chaotic-aur/chaotic-mirrorlist.pkg.tar.zst'

  # Add the chaotic-aur repository to /etc/pacman.conf if not already added
  if ! grep -q "\[chaotic-aur\]" /etc/pacman.conf; then
    sudo sh -c 'echo "
  [chaotic-aur]
  Include = /etc/pacman.d/chaotic-mirrorlist
  " >> /etc/pacman.conf'
    echo "chaotic-aur repository added to /etc/pacman.conf."
  else
    echo "chaotic-aur repository already exists in /etc/pacman.conf."
  fi
fi

# Update the package database
sudo pacman -Sy

# Function to check if a package is installed
is_installed() {
  pacman -Q "$1" > /dev/null 2>&1
}

# Function to check if a package is available in chaotic-aur
is_in_chaotic_aur() {
  pacman -Sl chaotic-aur | grep -q "$1 "
}

# List of packages to check and install if necessary
PACKAGE_LIST="
age
alacritty
bat
composer
dash
dashbinsh
deadbeef
deadbeef-mpris2-plugin
emote
espanso-bin
eza
fastfetch
fd
ffmpegthumbnailer
ffmpegthumbs
figlet
flameshot
fzf
fzf-tab-bin-git
gnome-disk-utility
gotop-bin
gufw
ibus-hangul
kdeconnect
keyd
lf-bin
magic-wormhole
mpv-full
mpv-thumbfast-git
mpv-uosc
neovim
nomacs-git
nvm
obsidian-bin
okular
peek
php-apcu
procs
ripgrep
shellcheck-bin
solaar
speedcrunch
syncthing
tdrop
tealdeer
tmux
trash-cli
ttf-jetbrains-mono-nerd
unrar
unzip
ventoy-bin
vscodium-bin
vscodium-bin-features
vscodium-bin-marketplace
wmctrl
zoxide
zsh
zsh-theme-powerlevel10k

{{ if eq .chezmoi.hostname "ndvr" }}
discord
flacon
fsearch-git
librewolf-bin
mullvad-vpn-bin
puddletag-git
rsgain
signal-desktop
soundconverter
sox
thunderbird
transmission-remote-gtk
whatsdesk-bin
yt-dlp
{{ end }}
"

# Iterate over each package in the list and install if not already installed
echo "$PACKAGE_LIST" | while IFS= read -r package_name; do
  # Skip empty lines
  if [ -n "$package_name" ]; then
    if is_installed "$package_name"; then
      echo "$package_name is already installed."
    else
      echo "Installing $package_name ..."

      if is_in_chaotic_aur "$package_name"; then
        echo "$package_name is in the chaotic-aur"
        # sudo pacman -S --noconfirm "chaotic-aur/$package_name"
      else
        echo "$package_name is in the aur"
        # sudo pacman -S --noconfirm "$package_name"
      fi
    fi
  fi
done
